package com.chinadaily.fragment

import android.os.Bundle
import android.support.v7.widget.RecyclerView
import android.text.TextUtils
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import com.alibaba.fastjson.JSON
import com.alibaba.fastjson.JSONObject
import com.alibaba.fastjson.TypeReference
import com.chinadaily.R
import com.chinadaily.adapter.EPaperAdapter
import com.chinadaily.base.LazyLoadBaseFragment
import com.chinadaily.data.CardItem
import com.chinadaily.http.FastJsonCallback
import com.chinadaily.http.HttpConstants
import com.chinadaily.http.httpGet
import com.chinadaily.utils.SPUtils
import com.leochuan.ScaleLayoutManager
import kotlinx.android.synthetic.main.epaper_fragment.*


class EPaperFragment : LazyLoadBaseFragment() {
    private val cardPagerAdapter by lazy { EPaperAdapter(lifecycle) }
    private val fastJsonCallback by lazy {
        object : FastJsonCallback<JSONObject>(lifecycle) {
            override fun onSuccess(body: JSONObject) {
                SPUtils.put("ePaper_config", body.toJSONString())
                initData()
            }

            override fun onError(exception: String) {
                initData()
            }
        }.apply {
            url = HttpConstants.E_PAPER_URL
            clazz = object : TypeReference<JSONObject>() {}
            pauseBaseRes = false
        }
    }

    private fun initData() {
        val ePaperConfig = SPUtils.getString("ePaper_config", "")
        if (!TextUtils.isEmpty(ePaperConfig)) {
            var data = JSON.parseArray(JSON.parseObject(ePaperConfig).getString("newestPubDate"), CardItem::class.java)
                    ?: mutableListOf()
            data = data.filter { it.publicationConfig.isHide == 0 }
            cardPagerAdapter.refreshData(data)
        }
    }

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
        return inflater.inflate(R.layout.epaper_fragment, container, false)
    }

    override fun onFragmentFirstVisible() {
        recyclerView.layoutManager = ScaleLayoutManager(context, 0, RecyclerView.HORIZONTAL)
        recyclerView.adapter = cardPagerAdapter
        httpGet(fastJsonCallback)
    }
}

